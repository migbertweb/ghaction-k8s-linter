name: Linter K8s Reutilizable con Telegram

on:
  workflow_call:
    inputs:
      manifest:
        description: 'Ruta del archivo YAML generado por KSOPS/Kustomize'
        required: true
        type: string

    secrets:
      TELEGRAM_BOT_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true

    outputs:
      lint_status:
        description: "Resultado del linting"
        value: ${{ jobs.lint.result }}

jobs:
  lint:
    name: Lint con kube-linter y kubeconform
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      - name: Descargar manifiesto generado
        uses: actions/download-artifact@v4
        with:
          name: final-yaml
          path: manifest

      - name: Instalar kube-linter y kubeconform con arkade
        uses: alexellis/arkade-get@master
        with:
          kubeconform: latest
          kube-linter: latest
  

      - name: Ejecutar kube-linter
        run: |
          echo "‚Üí Linting en ${{ inputs.manifest }}"
          kube-linter lint "${{ inputs.manifest }}" | tee kube-linter.log

      - name: Ejecutar kubeconform
        run: |
          echo "‚Üí Validaci√≥n con kubeconform en ${{ inputs.manifest }}"
          kubeconform -strict -summary -verbose "${{ inputs.manifest }}" | tee kubeconform.log

      - name: Guardar logs como artefacto si falla
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lint-logs
          path: |
            kube-linter.log
            kubeconform.log

  notify:
    name: Notificar por Telegram
    runs-on: ubuntu-latest
    needs: lint
    if: always()

    steps:
      - name: Descargar logs si fall√≥
        if: needs.lint.result != 'success'
        uses: actions/download-artifact@v4
        with:
          name: lint-logs
          path: logs

      - name: Enviar resultado a Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          LINT_RESULT: ${{ needs.lint.result }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
          FILE: ${{ inputs.manifest }}
        run: |
          if [ "$LINT_RESULT" = "success" ]; then
            STATUS_ICON="‚úÖ"
            STATUS_TEXT="*Linting exitoso*"
            MESSAGE="${STATUS_ICON} ${STATUS_TEXT}\nüì¶ *Repo:* \`${REPO}\`\nüåø *Branch:* \`${BRANCH}\`\nüìÑ *Archivo:* \`${FILE}\`\nüîó [Ver commit](https://github.com/${REPO}/commit/${COMMIT})"

            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="${MESSAGE}" \
              -d parse_mode="Markdown"
          else
            STATUS_ICON="‚ùå"
            STATUS_TEXT="*Linting fallido*"
            MESSAGE="${STATUS_ICON} ${STATUS_TEXT}\nüì¶ *Repo:* \`${REPO}\`\nüåø *Branch:* \`${BRANCH}\`\nüìÑ *Archivo:* \`${FILE}\`\nüîó [Ver commit](https://github.com/${REPO}/commit/${COMMIT})"

            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="${MESSAGE}" \
              -d parse_mode="Markdown"

            cd logs
            tar -czf lint-logs.tar.gz *.log

            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
              -F chat_id="${CHAT_ID}" \
              -F document=@lint-logs.tar.gz \
              -F caption="üìÑ Logs del linting fallido"


